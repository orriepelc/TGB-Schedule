<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>The Great Berate Schedule</title>
		<link rel="shortcut icon" href="favicon.png" type="image/png">
		<script src="moment.js"></script>
		<script src="moment-timezone.js"></script>
		<style>
			@font-face {
				font-family: 'Bahnschrift';
				font-style: normal;
				font-weight: normal;
				src: local('Bahnschrift'), url('bahnschrift.ttf') format('ttf');
			}

			html, body {
				height: 100%;
			}

			body {
				margin: 0;

				display: grid;
				grid-template-rows: auto 1fr;

				background: #6e0070;
				color: white;
				
				font-family: 'Bahnschrift', sans-serif;
				line-height: 1;
			}

			a {
				color: #fa00ff;
			}

			.main {
				margin: 10px;

				display: grid;
				row-gap: 10px;
			}

			.main > div {
				display: flex;
				align-items: center;
				justify-content: center;
				flex-grow: 1;

				background: rgb(40, 40, 40);
				padding: 15px;
			}

			.banner {
				width: 100%;
			}

			.hidden {
				display: none;
			}

			.status {
				font-size: 200%;
			}

			.countdown {
				text-align: center;
			}

			.clock {
				font-size: 200%;
			}

			table {
				border-collapse: collapse;
			}

			td, th {
				padding: 5px 10px;
				border: 1px solid white;
			}

			tr {
				transition: background-color 0.5s;
			}
			
			tr.current {
				background: rgba(255, 255, 0, 0.5);
			}

			.live-now {
				display: flex;
				flex-direction: column;
				text-align: center;
			}

			.live-now > div {
				display: none;
			}

			.live-now > div.live {
				display: unset;
			}

			.live-now > div:not(:first-child) {
				margin-top: 15px;
			}

			.live-badge {
				color: white;
				background: red;
				border-radius: 10px;
				padding: 2px 5px;
			}

			.social {
				column-gap: 20px;
			}

			.social img {
				width: 50px;
				height: 50px;
			}

			img.channel-icon {
				width: 25px;
				height: 25px;
			}
		</style>
    </head>
    <body>
		<img class="banner" src="banner.png" />
		<div class="main">
			<div class="status">
				<div class="countdown">
					<div>next stream in...</div>
					<div class="clock">00:00:00</div>
				</div>
				<div class="live-now">
					<div data-channel="main">The Great Berate's <a href="https://www.youtube.com/TheGreatBerate/live">YouTube channel</a> is <span class="live-badge">LIVE</span> now!</div>
					<div data-channel="puppy">Silly Puppy's <a href="https://www.twitch.tv/SillyPuppy0218">Twitch channel</a> is <span class="live-badge">LIVE</span> now!</div>
				</div>
			</div>
			<div>
				<table>
					<tr><th>Day</th><th>Time</th><th>Crew</th><th>Channel</th><th>Game</th></tr>
				</table>
			</div>
			<div class="social">
				<a href="https://www.youtube.com/TheGreatBerate"><img src="icons/youtube.png"/></a>
				<a href="https://www.twitch.tv/SillyPuppy0218"><img src="icons/twitch.png"/></a>
				<a href="https://discord.gg/qRMNGGZ"><img src="icons/discord.png"/></a>
			</div>
			<div><i>All times are shown in <span class="timezone">PT</span>.</i></div>
		</div>
		
		<script>
			const $ = selector => document.querySelector(selector);
			const $$ = selector => Array.from(document.querySelectorAll(selector));

			const scheduleURL = "https://tgb-schedule-server.glitch.me/schedule";
			const statusURL = "https://tgb-schedule-server.glitch.me/status";

			const offset = new Date().getTimezoneOffset() / -60;
			const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
			$(".timezone").textContent = `${timezone} (UTC${offset})`;

			fetch(scheduleURL)
				.then(response => response.json())
				.then(scheduleJSON => {
					const schedule = [];
					const table = $("table tbody");

					const channels = {
						main: {
							url: "https://www.youtube.com/TheGreatBerate/live",
							icon: "youtube"
						},
						puppy: {
							url: "https://www.twitch.tv/SillyPuppy0218",
							icon: "twitch"
						},
					}

					for (const row of scheduleJSON) {
						const rowElement = document.createElement("tr");
						const i = 0;
						for (const [index, cell] of row.entries()) {
							if (index == 5)
								continue;

							const cellElement = document.createElement("td");

							if (index != 3) {
								cellElement.textContent = cell;
							} else {
								const channel = channels[cell];

								const icon = document.createElement("img");
								icon.setAttribute("src", `icons/${channel.icon}.png`);
								icon.classList.add("channel-icon");

								const link = document.createElement("a");
								link.setAttribute("href", channel.url);

								link.append(icon);
								cellElement.append(link);
								cellElement.style.textAlign = "center";
							}
							
							rowElement.append(cellElement);
						}

						table.append(rowElement);

						const matches = /(\d{1,2}):00 ([AP]M)/.exec(row[1]);
						if (matches == null)
							continue;
		
						const hours = parseInt(matches[1]) + (matches[2] == "PM" && matches[1] !== "12" ? 12 : 0);
		
						schedule.push({
							row: rowElement,
							dayCell: rowElement.children[0],
							hoursCell: rowElement.children[1],
							time: moment().tz(row[5] || "America/Los_Angeles").day(row[0]).startOf("day").add(hours, "h").tz(timezone)
						});
					}

					onScheduleLoaded(schedule);
				});

			function onScheduleLoaded(schedule) {
				// Sort schedule by weekday
				function sortSchedule() {
					schedule.sort((a, b) => a.time.diff(b.time));
				}
				sortSchedule();
	
				// Update table text and fix row order
				for (const event of schedule) {
					event.dayCell.textContent = event.time.format("dddd");
					event.hoursCell.textContent = event.time.format("h A");
				}

				// Countdown
				const countdown = $(".countdown");
				const clock = $(".clock");
				let currentEvent;
				let anyoneLive = false;
				function updateClock() {
					const previousEvent = currentEvent;
					for (const event of schedule) {
						const difference = event.time.diff(moment());
						if (difference < 0) {
							event.pastTime = event.time.clone();
							event.time.day(event.time.day() + 7);

							sortSchedule();
						}
					}

					for (const event of schedule) {
						const difference = event.time.diff(moment());
						if (difference >= 0) {
							if (anyoneLive)
								break;

							const duration = moment.duration(difference);
							clock.textContent = [duration.hours(), duration.minutes(), duration.seconds()].map(number => number.toString().padStart(2, "0")).join(":");
	
							currentEvent = event;
							break;
						}
					}

					if (anyoneLive) {
						for (const event of Array.from(schedule).reverse()) {
							if (event.pastTime) {
								currentEvent = event;
								break;
							}
						}
					}

					if (currentEvent != previousEvent) {
						if (previousEvent != null) {
							previousEvent.row.classList.remove("current");
						}

						currentEvent.row.classList.add("current");
					}
				}
	
				setInterval(updateClock, 1000);
				updateClock();

				// Live status
				const status = $(".status");
				const channels = $$(".live-now > div");
				function updateStatus() {
					fetch(statusURL)
						.then(response => response.json())
						.then(statusJSON => {
							anyoneLive = false;
							for (const channelElement of channels) {
								channelElement.classList.toggle("live", statusJSON[channelElement.dataset.channel]);
								anyoneLive |= statusJSON[channelElement.dataset.channel];
							}

							countdown.classList.toggle("hidden", anyoneLive);
						})
				}

				setInterval(updateStatus, 60 * 1000);
				updateStatus();
			}
		</script>
    </body>
</html>